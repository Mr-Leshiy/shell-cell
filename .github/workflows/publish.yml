name: Publish to crates.io

on:
  release:
    types: [created]

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal

    - name: Get release version
      id: release_version
      run: |
        # Extract version from release tag (e.g., v0.1.0 -> 0.1.0)
        RELEASE_TAG="${{ github.event.release.tag_name }}"
        RELEASE_VERSION="${RELEASE_TAG#v}"
        echo "version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $RELEASE_VERSION"

    - name: Get current crate version
      id: crate_version
      run: |
        VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].version')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Crate version: $VERSION"

    - name: Verify versions match
      run: |
        RELEASE_VERSION="${{ steps.release_version.outputs.version }}"
        CRATE_VERSION="${{ steps.crate_version.outputs.version }}"

        if [ "$RELEASE_VERSION" != "$CRATE_VERSION" ]; then
          echo "Error: Release version ($RELEASE_VERSION) does not match crate version ($CRATE_VERSION)"
          exit 1
        fi

        echo "Version verified: $CRATE_VERSION"

    - name: Publish to crates.io
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: cargo publish --token $CARGO_REGISTRY_TOKEN
